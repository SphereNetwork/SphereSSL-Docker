@page
@model SphereSSLv2.Pages.ManageRenewalsModel
@{
    ViewData["Title"] = "Manage";
}
<div class="container-fluid px-4">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-md-12 col-sm-12 mb-4">
            <h3 class="title text-center mb-3">Manage Certificates</h3>
            <div class="card bg-light text-dark shadow-sm p-4">
                <h3 class="title text-dark text-center mb-3">Your Certificates</h3>
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-striped table-hover align-middle mb-3" id="certTable">
                        <thead>
                            <tr>
                                <th class="text-center" style="cursor:pointer;" onclick="sortCertTable(0)">Domain <span id="domainSortIcon">⇅</span></th>
                                <th class="text-center" style="cursor:pointer;" onclick="sortCertTable(1)">Status <span id="statusSortIcon">⇅</span></th>
                                <th class="text-center" style="cursor:pointer;" onclick="sortCertTable(2)">Days Left <span id="daysremainingSortIcon">⇅</span></th>
                                <th class="text-center" style="cursor:pointer;" onclick="sortCertTable(3)">AutoRenew <span id="autorenewSortIcon">⇅</span></th>
                                <th style="width:140px"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.CertRecords != null && Model.CertRecords.Any())
                            {
                                foreach (var cert in Model.CertRecords)
                                {
                                    var status = "";
                                    if (cert.ExpiryDate < DateTime.UtcNow)
                                    {
                                        status = "Expired";
                                    }
                                    else if (cert.ExpiryDate <= DateTime.UtcNow.AddDays(30))
                                    {
                                        status = "Expiring";
                                    }
                                    else
                                    {
                                        status = "Active";
                                    }
                                    int daysRemaining = (cert.ExpiryDate - DateTime.UtcNow).Days;
                                
                                    <tr data-cert-id="@cert.OrderId">
                                        <td id="certTableDomain">
                                            @if (cert.Challenges != null && cert.Challenges.Any())
                                            {
                                                <div class="d-flex flex-wrap align-items-center gap-1">
                                                    @foreach (var challenge in cert.Challenges.DistinctBy(x => x.Domain))
                                                    {
                                                        <a href="https://@challenge.Domain" target="_blank"
                                                           class="badge rounded-pill bg-secondary text-decoration-underline fw-normal me-1 mb-1"
                                                           style="font-size: 1em;"
                                                           title="View @challenge.Domain">@challenge.Domain</a>
                                                    }
                                                </div>
                                                <div class="mt-1 small text-muted">
                                                    Providers: @string.Join(", ", cert.Challenges.Select(x => x.ProviderId).Distinct())
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">No domains</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            @if (status == "Expired")
                                            {
                                                <span class="badge bg-dark">Expired</span>
                                            }
                                            else if (status == "Expiring")
                                            {
                                                <span class="badge-pulse" style="background:#eab308; color:#222;" title="This certificate will expire soon!">Expiring</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-primary">Active</span>
                                            }
                                        </td>
                                        <td class="text-center" id="certTableDaysRemaining">
                                            @if (daysRemaining < 0)
                                            {
                                                <span class="badge bg-danger">@daysRemaining</span>
                                            }
                                            else if (daysRemaining < 30)
                                            {
                                                <span class="badge" style="background:#eab308; color:#222;">@daysRemaining</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success">@daysRemaining</span>
                                            }
                                        </td>
                                        <td class="text-center" id="certTableAutoRenew">
                                            @if (cert.autoRenew)
                                            {
                                                <span class="badge bg-success">On</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">Off</span>
                                            }
                                        </td>

                                        <td style="white-space:nowrap;">
                                            <button onclick="showCertRecordModal('@cert.OrderId')" class="btn btn-sm btn-success me-1">View</button>
                                            <button onclick="showManageCertModal('@cert.OrderId')" class="btn btn-sm btn-info">Manage</button>
                                        </td>
                     
                                    </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="3" class="text-muted text-center">No users found.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            </div>


        </div>
                
    </div>
</div>


<!-- Sort CERT Table -->
<script>
    let sortDirection3 = [1, 1, 1, 1];

    function sortCertTable(colIndex) {
        const table3 = document.getElementById("certTable");
        const tbody3 = table3.tBodies[0];
        const rows3 = Array.from(tbody3.querySelectorAll("tr")).filter(
            tr => tr.children.length > 2
        );

        // Toggle direction
        sortDirection3[colIndex] *= -1;

        rows3.sort((a, b) => {
            let aVal = a.cells[colIndex].innerText.trim();
            let bVal = b.cells[colIndex].innerText.trim();

            if (colIndex === 2) {
                // AutoRenew: "On" > "Off"
                aVal = aVal.toLowerCase() === "on" ? 1 : 0;
                bVal = bVal.toLowerCase() === "on" ? 1 : 0;
                return (aVal - bVal) * sortDirection3[colIndex];
            } else if (colIndex === 3) {
                // Days Remaining: numeric sort
                aVal = parseInt(aVal, 10);
                bVal = parseInt(bVal, 10);
                return (aVal - bVal) * sortDirection3[colIndex];
            } else {
                // String sort (domain, status)
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
                if (aVal < bVal) return -1 * sortDirection3[colIndex];
                if (aVal > bVal) return 1 * sortDirection3[colIndex];
                return 0;
            }
        });

        rows3.forEach(row => tbody3.appendChild(row));

        // Update sort icons
        document.getElementById('domainSortIcon').textContent = colIndex === 0
            ? (sortDirection3[0] === 1 ? '↑' : '↓') : '⇅';
        document.getElementById('statusSortIcon').textContent = colIndex === 1
            ? (sortDirection3[1] === 1 ? '↑' : '↓') : '⇅';
        document.getElementById('autorenewIcon').textContent = colIndex === 3
            ? (sortDirection3[2] === 1 ? '↑' : '↓') : '⇅';
        document.getElementById('daysremaining').textContent = colIndex === 2
            ? (sortDirection3[3] === 1 ? '↑' : '↓') : '⇅';
    }
</script>



<style>


    /* Striped rows */
    #certTable tbody tr:nth-child(odd) {
        background-color: #f5f8fc;
    }

    /* Hover effect */
    #certTable tbody tr:hover {
        background-color: #e2ebfa !important;
        transition: background 0.2s;
    }

    /* Manage button pop */
    #certTable .btn-info {
        background: linear-gradient(90deg,#0ea5e9 20%,#2563eb 100%);
        border: none;
        color: #fff;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(30,60,120,0.10);
    }

        #certTable .btn-info:hover {
            background: #2563eb;
            color: #fff;
        }
        </style>